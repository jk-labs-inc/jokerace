import AddEntryChargeContract from "@contracts/bytecodeAndAbi/Contest.4.1.addEntryCharge.sol/Contest.json";
import RmImmutableKeywordContract from "@contracts/bytecodeAndAbi/Contest.4.10.rmImmutableKeyword.sol/Contest.json";
import GasOptimizeGettersContract from "@contracts/bytecodeAndAbi/Contest.4.11.gasOptimizeGetters.sol/Contest.json";
import AllowCancelCompletedContract from "@contracts/bytecodeAndAbi/Contest.4.12.allowCancelCompleted.sol/Contest.json";
import AddCommentsContract from "@contracts/bytecodeAndAbi/Contest.4.13.addComments.sol/Contest.json";
import RmShadowingPropIdsContract from "@contracts/bytecodeAndAbi/Contest.4.14.rmShadowingPropIds.sol/Contest.json";
import RmUnusedViewFuncContract from "@contracts/bytecodeAndAbi/Contest.4.15.rmUnusedViewFunc.sol/Contest.json";
import PinAllToSameContract from "@contracts/bytecodeAndAbi/Contest.4.16.pinAllToSame.sol/Contest.json";
import MitToAGPLContract from "@contracts/bytecodeAndAbi/Contest.4.17.mitToAGPL.sol/Contest.json";
import AddEmergencyFuncsContract from "@contracts/bytecodeAndAbi/Contest.4.18.addEmergencyFuncs.sol/Contest.json";
import AddMoreAttributionContract from "@contracts/bytecodeAndAbi/Contest.4.19.addMoreAttribution.sol/Contest.json";
import UpdateSortingAlgoContract from "@contracts/bytecodeAndAbi/Contest.4.2.updateSortingAlgo.sol/Contest.json";
import AddGetDeletedAuthorsContract from "@contracts/bytecodeAndAbi/Contest.4.20.addGetDeletedAuthors.sol/Contest.json";
import AddContentToEventsContract from "@contracts/bytecodeAndAbi/Contest.4.21.addContentToEvents.sol/Contest.json";
import RefactorDistributionFuncContract from "@contracts/bytecodeAndAbi/Contest.4.22.refactorDistributionFunc.sol/Contest.json";
import AddCostToVoteContract from "@contracts/bytecodeAndAbi/Contest.4.23.addCostToVote.sol/Contest.json";
import RefactorCostDistroContract from "@contracts/bytecodeAndAbi/Contest.4.24.refactorCostDistro.sol/Contest.json";
import PayPerVoteContract from "@contracts/bytecodeAndAbi/Contest.4.25.payPerVote.sol/Contest.json";
import CleanUpConstructorsContract from "@contracts/bytecodeAndAbi/Contest.4.26.cleanUpConstructors.sol/Contest.json";
import AnyoneCanVoteContract from "@contracts/bytecodeAndAbi/Contest.4.27.anyoneCanVote.sol/Contest.json";
import UpdateForgeLibsContract from "@contracts/bytecodeAndAbi/Contest.4.28.updateForgeLibs.sol/Contest.json";
import SetSplitDestinationContract from "@contracts/bytecodeAndAbi/Contest.4.29.setSplitDestination.sol/Contest.json";
import NewValueAlreadyInArrayContract from "@contracts/bytecodeAndAbi/Contest.4.3.newValueAlreadyInArray.sol/Contest.json";
import MakeJkLabsSplitConfigurableContract from "@contracts/bytecodeAndAbi/Contest.4.30.makeJkLabsSplitConfigurable.sol/Contest.json";
import AddMetadataFieldsContract from "@contracts/bytecodeAndAbi/Contest.4.31.addMetadataFields.sol/Contest.json";
import CheckCanceledContract from "@contracts/bytecodeAndAbi/Contest.4.32.checkCanceled.sol/Contest.json";
import MustCancelToWithdrawContract from "@contracts/bytecodeAndAbi/Contest.4.33.mustCancelToWithdraw.sol/Contest.json";
import AllowJkLabsDestUpdateContract from "@contracts/bytecodeAndAbi/Contest.4.34.allowJkLabsDestUpdate.sol/Contest.json";
import OnlyCreatorChangeMerkleContract from "@contracts/bytecodeAndAbi/Contest.4.35.onlyCreatorChangeMerkle.sol/Contest.json";
import NoCommentAfterCloseContract from "@contracts/bytecodeAndAbi/Contest.4.36.noCommentAfterClose.sol/Contest.json";
import EditTitleDescContract from "@contracts/bytecodeAndAbi/Contest.4.37.editTitleDesc.sol/Contest.json";
import UseCustomErrorsContract from "@contracts/bytecodeAndAbi/Contest.4.4.useCustomErrors.sol/Contest.json";
import CleanUpSortingContract from "@contracts/bytecodeAndAbi/Contest.4.5.cleanUpSorting.sol/Contest.json";
import RestructureExtensionsAndUtilsContract from "@contracts/bytecodeAndAbi/Contest.4.6.restructureExtensionsAndUtils.sol/Contest.json";
import RmUnnecessaryVirtualsContract from "@contracts/bytecodeAndAbi/Contest.4.7.rmUnnecessaryVirtuals.sol/Contest.json";
import DeleteInMapAfterForLoopContract from "@contracts/bytecodeAndAbi/Contest.4.8.deleteInMapAfterForLoop.sol/Contest.json";
import AddGetPropIdsWithForVotesContract from "@contracts/bytecodeAndAbi/Contest.4.9.addGetPropIdsWithForVotes.sol/Contest.json";
import RmDownvotingContract from "@contracts/bytecodeAndAbi/Contest.5.1.rmDownvoting.sol/Contest.json";
import AddErc20CancelledCheckContract from "@contracts/bytecodeAndAbi/Contest.5.2.addErc20CancelledCheck.sol/Contest.json";
import EntrantsCanDeleteContract from "@contracts/bytecodeAndAbi/Contest.5.3.entrantsCanDelete.sol/Contest.json";
import OfficialModulePointsToContestContract from "@contracts/bytecodeAndAbi/Contest.5.4.officialModulePointsToContest.sol/Contest.json";
import VoterRewardsContract from "@contracts/bytecodeAndAbi/Contest.5.5.voterRewards.sol/Contest.json";
import SetPeriodLimitsContract from "@contracts/bytecodeAndAbi/Contest.5.6.setPeriodLimits.sol/Contest.json";
import VotingPriceCurvesContract from "@contracts/bytecodeAndAbi/Contest.5.7.votingPriceCurves.sol/Contest.json";
import AddModuleTrackingContract from "@contracts/bytecodeAndAbi/Contest.5.8.addModuleTracking.sol/Contest.json";
import CalcCorrectMinuteContract from "@contracts/bytecodeAndAbi/Contest.5.9.calcCorrectMinute.sol/Contest.json";
import OnlyDeleteInEntryContract from "@contracts/bytecodeAndAbi/Contest.5.10.onlyDeleteInEntry.sol/Contest.json";
import AntiRugContract from "@contracts/bytecodeAndAbi/Contest.5.11.antiRug.sol/Contest.json";
import CorrectDelayVarContract from "@contracts/bytecodeAndAbi/Contest.5.12.correctDelayVar.sol/Contest.json";
import RankLimitCheckContract from "@contracts/bytecodeAndAbi/Contest.5.13.rankLimitCheck.sol/Contest.json";
import RmEntryRewardsContract from "@contracts/bytecodeAndAbi/Contest.5.14.rmEntryRewards.sol/Contest.json";
import VoteAndEarnOnlyContract from "@contracts/bytecodeAndAbi/Contest.6.1.voteAndEarnOnly.sol/Contest.json";
import RmDeleteVotesUpdateContract from "@contracts/bytecodeAndAbi/Contest.6.2.rmDeleteVotesUpdate.sol/Contest.json";
import DocsDeleteOnlyInEntryContract from "@contracts/bytecodeAndAbi/Contest.6.3.docsDeleteOnlyInEntry.sol/Contest.json";
import RmUnusedErrorsContract from "@contracts/bytecodeAndAbi/Contest.6.4.rmUnusedErrors.sol/Contest.json";
import OnlySetOfficialModuleOnceContract from "@contracts/bytecodeAndAbi/Contest.6.5.onlySetOfficialModuleOnce.sol/Contest.json";
import FixStateErrorsContract from "@contracts/bytecodeAndAbi/Contest.6.6.fixStateErrors.sol/Contest.json";
import UpdatePeriodConstraintsContract from "@contracts/bytecodeAndAbi/Contest.6.7.updatePeriodConstraints.sol/Contest.json";
import CorrectPeriodConstraintsContract from "@contracts/bytecodeAndAbi/Contest.6.8.correctPeriodConstraints.sol/Contest.json";
import AlwaysSelfFundContract from "@contracts/bytecodeAndAbi/Contest.6.9.alwaysSelfFund.sol/Contest.json";
import DeprecateCostToEnterContract from "@contracts/bytecodeAndAbi/Contest.6.10.deprecateCostToEnter.sol/Contest.json";
import DeprecateFlatCurvesContract from "@contracts/bytecodeAndAbi/Contest.6.11.deprecateFlatCurves.sol/Contest.json";
import AddCreatorSplitContract from "@contracts/bytecodeAndAbi/Contest.6.12.addCreatorSplit.sol/Contest.json";
import DeployedContestContract from "@contracts/bytecodeAndAbi/Contest.sol/Contest.json";
import { MAX_TIME_TO_WAIT_FOR_RPC, executeWithTimeout } from "./timeout";
import { createTransport } from "@config/wagmi/transports";
import { Chain, createPublicClient, getContract } from "viem";
import { getChainFromId } from "./getChainFromId";

type ContractData = {
  abi: any;
  deployedBytecode?: { object: string };
};

const VERSION_TO_CONTRACT: Record<string, ContractData> = {
  "6.12": AddCreatorSplitContract,
  "6.11": DeprecateFlatCurvesContract,
  "6.10": DeprecateCostToEnterContract,
  "6.9": AlwaysSelfFundContract,
  "6.8": CorrectPeriodConstraintsContract,
  "6.7": UpdatePeriodConstraintsContract,
  "6.6": FixStateErrorsContract,
  "6.5": OnlySetOfficialModuleOnceContract,
  "6.4": RmUnusedErrorsContract,
  "6.3": DocsDeleteOnlyInEntryContract,
  "6.2": RmDeleteVotesUpdateContract,
  "6.1": VoteAndEarnOnlyContract,
  "5.14": RmEntryRewardsContract,
  "5.13": RankLimitCheckContract,
  "5.12": CorrectDelayVarContract,
  "5.11": AntiRugContract,
  "5.10": OnlyDeleteInEntryContract,
  "5.9": CalcCorrectMinuteContract,
  "5.8": AddModuleTrackingContract,
  "5.7": VotingPriceCurvesContract,
  "5.6": SetPeriodLimitsContract,
  "5.5": VoterRewardsContract,
  "5.4": OfficialModulePointsToContestContract,
  "5.3": EntrantsCanDeleteContract,
  "5.2": AddErc20CancelledCheckContract,
  "5.1": RmDownvotingContract,
  "4.37": EditTitleDescContract,
  "4.36": NoCommentAfterCloseContract,
  "4.35": OnlyCreatorChangeMerkleContract,
  "4.34": AllowJkLabsDestUpdateContract,
  "4.33": MustCancelToWithdrawContract,
  "4.32": CheckCanceledContract,
  "4.31": AddMetadataFieldsContract,
  "4.30": MakeJkLabsSplitConfigurableContract,
  "4.29": SetSplitDestinationContract,
  "4.28": UpdateForgeLibsContract,
  "4.27": AnyoneCanVoteContract,
  "4.26": CleanUpConstructorsContract,
  "4.25": PayPerVoteContract,
  "4.24": RefactorCostDistroContract,
  "4.23": AddCostToVoteContract,
  "4.22": RefactorDistributionFuncContract,
  "4.21": AddContentToEventsContract,
  "4.20": AddGetDeletedAuthorsContract,
  "4.19": AddMoreAttributionContract,
  "4.18": AddEmergencyFuncsContract,
  "4.17": MitToAGPLContract,
  "4.16": PinAllToSameContract,
  "4.15": RmUnusedViewFuncContract,
  "4.14": RmShadowingPropIdsContract,
  "4.13": AddCommentsContract,
  "4.12": AllowCancelCompletedContract,
  "4.11": GasOptimizeGettersContract,
  "4.10": RmImmutableKeywordContract,
  "4.9": AddGetPropIdsWithForVotesContract,
  "4.8": DeleteInMapAfterForLoopContract,
  "4.7": RmUnnecessaryVirtualsContract,
  "4.6": RestructureExtensionsAndUtilsContract,
  "4.5": CleanUpSortingContract,
  "4.4": UseCustomErrorsContract,
  "4.3": NewValueAlreadyInArrayContract,
  "4.2": UpdateSortingAlgoContract,
  "4.1": AddEntryChargeContract,
};

export interface ContestContractVersionResult {
  abi: any | null;
  version: string;
  deployedBytecode?: string;
}

export async function getContestContractVersion(
  address: string,
  chainId: number,
): Promise<ContestContractVersionResult> {
  try {
    const chain = getChainFromId(chainId);
    const client = createPublicClient({
      chain: chain,
      transport: createTransport(chain as Chain),
    });

    // Get earliest ABI just so we can call VERSION() to start, since we know all ABIs will have that function
    const contract = getContract({
      address: address as `0x${string}`,
      client,
      abi: AddEntryChargeContract.abi,
    });

    // Here we check if all RPC calls are successful, otherwise we throw an error and return empty ABI
    const version = (await executeWithTimeout(MAX_TIME_TO_WAIT_FOR_RPC, contract.read.version())) as string;

    const contractData = VERSION_TO_CONTRACT[version] ?? DeployedContestContract;

    return {
      abi: contractData.abi,
      version,
      deployedBytecode: contractData.deployedBytecode?.object,
    };
  } catch (error: unknown) {
    console.error(`Error while fetching the contract version for address ${address} on chainId ${chainId}:`, error);
    return { abi: null, version: "error", deployedBytecode: undefined };
  }
}

export default getContestContractVersion;
